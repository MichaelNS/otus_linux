---
- name: create /var/www/{{ server_name }} directory for unarchiving
  file:
    path: /var/www/{{ server_name }}
    state: directory

- name: Download and unpack latest WordPress
  unarchive:
    src: https://wordpress.org/wordpress-5.0.13.tar.gz
    dest: "/var/www/{{ server_name }}"
    remote_src: yes
    creates: "/var/www/{{ server_name }}/wordpress"



# todo - move
# - name: WEB SERVER | CONFIGURE SELINUX FOR NGINX
#   shell: semanage fcontext -a -t httpd_sys_rw_content_t /var/www/site.project/logs/access.log ; restorecon -v /var/www/site.project/logs/access.log ; semanage fcontext -a -t httpd_sys_rw_content_t /var/www/site.project/logs/error.log ; restorecon -v /var/www/site.project/logs/error.log



- name: Set ownership Redhat
  file:
    path: "/var/www/{{ server_name }}"
    state: directory
    recurse: yes
    owner: nginx
    group: nginx
  when:
    - ansible_os_family == "RedHat"

- name: Set ownership Debian
  file:
    path: "/var/www/{{ server_name }}"
    state: directory
    recurse: yes
    owner: www-data
    group: www-data
  when:
    - ansible_os_family == "Debian"



- name: Copy WordPress config file
  template:
    src: wp-config.php.j2
    dest: "/var/www/{{ server_name }}/wordpress/wp-config.php"



- name: install SEManage
  yum: pkg=policycoreutils-python state=present

- name: set the SELinux policy for the Wordpress directory
  command: semanage fcontext -a -t httpd_sys_content_t "{{ wp_home_dir }}/wordpress(/.*)?"
  tags:
  - skip_ansible_lint

- name: set the SELinux policy for wp-config.php
  command: semanage fcontext -a -t httpd_sys_script_exec_t "{{ wp_home_dir }}/wp-config\.php"
  tags:
  - skip_ansible_lint

- name: set the SELinux policy for wp-content directory
  command: semanage fcontext -a -t httpd_sys_rw_content_t "{{ wp_home_dir }}/wp-content(/.*)?"
  tags:
  - skip_ansible_lint

- name: set the SELinux policy for the *.php files
  command: semanage fcontext -a -t httpd_sys_script_exec_t "{{ wp_home_dir }}/wordpress/.*\.php"
  tags:
  - skip_ansible_lint

- name: set the SELinux policy for the Upgrade directory
  command: semanage fcontext -a -t httpd_sys_rw_content_t "{{ wp_home_dir }}/wp-content/upgrade(/.*)?"
  tags:
  - skip_ansible_lint

- name: set the SELinux policy for the Uploads directory
  command: semanage fcontext -a -t httpd_sys_rw_content_t "{{ wp_home_dir }}/wp-content/uploads(/.*)?"
  tags:
  - skip_ansible_lint

- name: set the SELinux policy for the wp-includes php files
  command: semanage fcontext -a -t httpd_sys_script_exec_t "{{ wp_home_dir }}/wp-includes/.*\.php"
  tags:
  - skip_ansible_lint

- name: set the SELinux on all the Files
  command: restorecon -Rv {{ wp_home_dir }}
#  command: restorecon -RF /srv/wordpress
  tags:
  - skip_ansible_lint

- name: set the SELinux bool to allow connection to db
  command: setsebool -P httpd_can_network_connect_db 1
  tags:
  - skip_ansible_lint

- name: Start php-fpm Service
  service: name=php-fpm state=started enabled=yes
  ignore_errors: true
  tags:
  - skip_ansible_lint

- include_tasks: setup-borgbackup-client.yml

